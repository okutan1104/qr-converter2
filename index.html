<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR å¤‰æ›ãƒ„ãƒ¼ãƒ«ï¼ˆã‚«ãƒ¡ãƒ©ï¼‹ç”»åƒï¼‰</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",sans-serif;margin:0;padding:1rem;background:#f6f7fb;color:#111}
  h1{font-size:1.1rem;margin:0 0 .5rem}
  #container{max-width:720px;margin:0 auto}
  #video, canvas{width:100%;max-width:420px;border-radius:8px;border:1px solid #ccc;background:#fff}
  .row{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.75rem}
  button{padding:.6rem .9rem;border-radius:6px;border:0;background:#0078d7;color:#fff;cursor:pointer}
  input[type=file]{padding:.5rem}
  pre{background:#fff;padding:.5rem;border-radius:6px;border:1px solid #e3e3e3;overflow:auto}
  #tips{font-size:.9rem;color:#444;margin-top:.5rem}
</style>
</head>
<body>
<div id="container">
  <h1>ğŸ“± QR å¤‰æ›ãƒ„ãƒ¼ãƒ«ï¼ˆã‚«ãƒ¡ãƒ© & ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰</h1>
  <p>æ—§QRã‚’èª­ã¿å–ã‚Šã€ä»¥ä¸‹ã®å½¢å¼ã§æ–°QRã‚’ç”Ÿæˆã—ã¾ã™ã€‚<br>
     ä¾‹1ï¼‰<code>"2025/10/31","ARACRD705082","22","PARA00001765","SEIKEI"</code><br>
     â†’ <code>,,ARACRD705082,999,,22.000</code><br><br>
     ä¾‹2ï¼‰<code>2025-10-16,532238,532238,2,KANSEIHIN,10</code><br>
     â†’ <code>,,532238,999,,10.000</code>
  </p>

  <div id="cameraArea">
    <video id="video" autoplay playsinline muted></video>
    <div class="row">
      <button id="startCamera">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
      <button id="stopCamera">ã‚«ãƒ¡ãƒ©åœæ­¢</button>
      <button id="useImageMode">ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ä½¿ã†</button>
    </div>
  </div>

  <div style="margin-top:.8rem">
    <input type="file" id="fileInput" accept="image/*">
  </div>

  <div id="tips">â€» ã‚«ãƒ¡ãƒ©ã¯ HTTPS ã¾ãŸã¯ localhost ã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ãªã„å ´åˆã¯ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚</div>

  <hr style="margin:1rem 0">

  <div id="resultArea">
    <h2 style="font-size:1rem;margin:.5rem 0">çµæœ</h2>
    <div id="oldText"><strong>æ—§QR:</strong><pre id="oldPre">â€” ã¾ã èª­ã¿å–ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“ â€”</pre></div>
    <div id="newText" style="margin-top:.6rem"><strong>æ–°QRãƒ†ã‚­ã‚¹ãƒˆ:</strong><pre id="newPre">â€”</pre></div>
    <canvas id="outQR" width="300" height="300" style="display:block;margin-top:.6rem"></canvas>
    <div class="row" style="margin-top:.6rem">
      <button id="downloadBtn">æ–°QRã‚’ç”»åƒã§ä¿å­˜</button>
      <button id="copyBtn">æ–°QRãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>
</div>

<!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆCDNï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<script>
(async function(){
  const video = document.getElementById('video');
  const startCameraBtn = document.getElementById('startCamera');
  const stopCameraBtn = document.getElementById('stopCamera');
  const fileInput = document.getElementById('fileInput');
  const outQR = document.getElementById('outQR');
  const oldPre = document.getElementById('oldPre');
  const newPre = document.getElementById('newPre');
  const downloadBtn = document.getElementById('downloadBtn');
  const copyBtn = document.getElementById('copyBtn');
  const useImageModeBtn = document.getElementById('useImageMode');

  let stream = null;
  let scanning = false;
  let scanReq = null;

  function formatTo3Decimal(val){
    if(val === undefined || val === null) return '';
    const s = String(val).trim();
    if(s === '') return '';
    const num = Number(s.replace(/[^0-9.\-]/g,''));
    if(!isNaN(num)) return num.toFixed(3);
    return s;
  }

  // âœ… å®Œæˆç‰ˆï¼šä¾‹1ï¼ˆã‚¯ã‚©ãƒ¼ãƒˆä»˜ãï¼‰ã¨ä¾‹2ï¼ˆCSVå½¢å¼ï¼‰ã®ä¸¡æ–¹å¯¾å¿œ
  function convertOldToNew(text){
    try {
      const t = text.trim();
      if (t === '') return 'å¤‰æ›ã‚¨ãƒ©ãƒ¼ï¼ˆç©ºãƒ‡ãƒ¼ã‚¿ï¼‰';

      // ã‚¯ã‚©ãƒ¼ãƒˆä»˜ããƒ»ãªã—ä¸¡å¯¾å¿œã®åˆ†å‰²å‡¦ç†
      const parts = t.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)?.map(x =>
        x.replace(/^"|"$/g, '').trim()
      ) || [];

      if (parts.length < 3) return 'å¤‰æ›ã‚¨ãƒ©ãƒ¼ï¼ˆè¦ç´ ä¸è¶³ï¼‰';

      // å…±é€šãƒ­ã‚¸ãƒƒã‚¯
      const codeA = (parts[1] || '').trim();
      let qtyRaw = '';

      // ä¾‹1ã®ã‚ˆã†ãªå½¢å¼ã§ã¯3ç•ªç›®ã®è¦ç´ ãŒæ•°é‡
      // ä¾‹2ã®ã‚ˆã†ãªå½¢å¼ã§ã¯æœ«å°¾ãŒæ•°é‡
      if (!isNaN(Number(parts[2]))) {
        qtyRaw = parts[2];
      } else {
        qtyRaw = parts[parts.length - 1];
      }

      const newQty = '999';
      const newVal = formatTo3Decimal(qtyRaw);

      return ['', '', codeA, newQty, '', newVal].join(',');

    } catch (e) {
      console.error(e);
      return 'å¤‰æ›ã‚¨ãƒ©ãƒ¼';
    }
  }

  function drawQRCode(text){
    outQR.getContext('2d').clearRect(0,0,outQR.width,outQR.height);
    QRCode.toCanvas(outQR, text, { width: Math.min(300, outQR.width) }, function(err){
      if(err) console.error(err);
    });
  }

  function processDecoded(text){
    oldPre.textContent = text;
    const newText = convertOldToNew(text);
    newPre.textContent = newText;
    drawQRCode(newText);
  }

  async function startCamera(){
    if(scanning) return;
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;
      await video.play();
      scanning = true;
      scanLoop();
    }catch(err){
      alert('ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nï¼ˆHTTPS ã§ã®å…¬é–‹ãŒå¿…è¦ã§ã™ï¼‰\n' + err);
      console.error(err);
    }
  }

  function stopCamera(){
    scanning = false;
    if(scanReq) cancelAnimationFrame(scanReq);
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    video.pause();
    video.srcObject = null;
  }

  function scanLoop(){
    if(!scanning) return;
    const canvas = document.createElement('canvas');
    const w = video.videoWidth;
    const h = video.videoHeight;
    if(w===0 || h===0){ scanReq = requestAnimationFrame(scanLoop); return; }
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video,0,0,w,h);
    const imageData = ctx.getImageData(0,0,w,h);
    const code = jsQR(imageData.data, imageData.width, imageData.height);
    if(code && code.data){
      stopCamera();
      processDecoded(code.data);
      return;
    }
    scanReq = requestAnimationFrame(scanLoop);
  }

  fileInput.addEventListener('change', (ev)=>{
    const f = ev.target.files && ev.target.files[0];
    if(!f) return;
    const img = new Image();
    const url = URL.createObjectURL(f);
    img.onload = ()=> {
      const c = document.createElement('canvas');
      c.width = img.width;
      c.height = img.height;
      const ctx = c.getContext('2d');
      ctx.drawImage(img,0,0);
      const id = ctx.getImageData(0,0,c.width,c.height);
      const code = jsQR(id.data, id.width, id.height);
      if(code && code.data){
        processDecoded(code.data);
      } else {
        alert('QRãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ç”»åƒã‚’æ‹¡å¤§ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
      }
      URL.revokeObjectURL(url);
    };
    img.onerror = ()=> { alert('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); URL.revokeObjectURL(url); };
    img.src = url;
  });

  downloadBtn.addEventListener('click', ()=>{
    const link = document.createElement('a');
    link.download = 'new_qr.png';
    link.href = outQR.toDataURL('image/png');
    link.click();
  });

  copyBtn.addEventListener('click', async ()=>{
    const text = newPre.textContent || '';
    try{
      await navigator.clipboard.writeText(text);
      alert('æ–°QRãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
    }catch(e){
      prompt('ä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼ˆæ‰‹å‹•ï¼‰', text);
    }
  });

  startCameraBtn.addEventListener('click', ()=>startCamera());
  stopCameraBtn.addEventListener('click', ()=>stopCamera());
  useImageModeBtn.addEventListener('click', ()=> fileInput.scrollIntoView({behavior:'smooth'}));

  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    document.getElementById('tips').textContent = 'â€» ã‚«ãƒ¡ãƒ©ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã€‚ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆä¸‹ï¼‰ã‚’ãŠä½¿ã„ãã ã•ã„ã€‚';
  }
})();
</script>
</body>
</html>
